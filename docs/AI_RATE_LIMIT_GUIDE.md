# AI è®¿é—®é™åˆ¶åŠŸèƒ½æŒ‡å—

æœ¬æ–‡æ¡£è¯´æ˜ç¥æœºé˜åº”ç”¨ä¸­çš„ AI API è®¿é—®é™åˆ¶åŠŸèƒ½ï¼Œç”¨äºä¿æŠ¤ AI API èµ„æºï¼Œé˜²æ­¢æ»¥ç”¨ã€‚

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

AI è®¿é—®é™åˆ¶åŠŸèƒ½é€šè¿‡ IP åœ°å€è¿½è¸ªæ¯ä¸ªç”¨æˆ·çš„ AI è§£è¯»è¯·æ±‚æ¬¡æ•°ï¼Œå®ç°ä»¥ä¸‹ç›®æ ‡ï¼š

- **é™åˆ¶é¢‘ç‡**ï¼šæ¯ä¸ª IP åœ°å€æ¯å¤©æœ€å¤šè¯·æ±‚ 30 æ¬¡ï¼ˆå¯é…ç½®ï¼‰
- **è‡ªåŠ¨é‡ç½®**ï¼šæ¯å¤©å‡Œæ™¨è‡ªåŠ¨é‡ç½®è®¡æ•°
- **å®æ—¶è¿½è¸ª**ï¼šè®°å½•æ¯ä¸ªè¯·æ±‚çš„è¯¦ç»†ä¿¡æ¯
- **çµæ´»é…ç½®**ï¼šå¯é€šè¿‡ç¯å¢ƒå˜é‡è°ƒæ•´é™åˆ¶

## ğŸ”§ é…ç½®è¯´æ˜

åœ¨ `.env` æ–‡ä»¶ä¸­é…ç½®ï¼š

```env
# AIè®¿é—®é™åˆ¶é…ç½®
# æ¯ä¸ªIPæ¯å¤©æœ€å¤šè¯·æ±‚æ¬¡æ•°
AI_DAILY_LIMIT=30

# æ˜¯å¦å¯ç”¨AIè®¿é—®é™åˆ¶ï¼ˆtrue/falseï¼‰
AI_RATE_LIMIT_ENABLED=true
```

### é…ç½®é¡¹è¯´æ˜

- `AI_DAILY_LIMIT`ï¼šæ¯ä¸ª IP æ¯å¤©çš„æœ€å¤§è¯·æ±‚æ¬¡æ•°ï¼ˆé»˜è®¤ 30ï¼‰
- `AI_RATE_LIMIT_ENABLED`ï¼šæ˜¯å¦å¯ç”¨é™åˆ¶åŠŸèƒ½ï¼ˆé»˜è®¤å¯ç”¨ï¼‰

## ğŸ“Š æ•°æ®åº“ç»“æ„

ç³»ç»Ÿä¼šè‡ªåŠ¨åˆ›å»º `ai_api_usage` è¡¨æ¥è®°å½•è®¿é—®ä¿¡æ¯ï¼š

```sql
CREATE TABLE ai_api_usage (
    id INTEGER PRIMARY KEY,
    user_id INTEGER,              -- å…³è”ç”¨æˆ·IDï¼ˆå¦‚æœå·²ç™»å½•ï¼‰
    ip_address TEXT NOT NULL,     -- è¯·æ±‚è€…IPåœ°å€
    endpoint TEXT NOT NULL,       -- è¯·æ±‚çš„APIç«¯ç‚¹
    request_date DATE NOT NULL,   -- è¯·æ±‚æ—¥æœŸ
    request_count INTEGER,        -- å½“å¤©ç´¯è®¡è¯·æ±‚æ¬¡æ•°
    created_at DATETIME,          -- é¦–æ¬¡è¯·æ±‚æ—¶é—´
    updated_at DATETIME           -- æœ€åæ›´æ–°æ—¶é—´
);
```

## ğŸš¦ å·¥ä½œåŸç†

1. **è¯·æ±‚æ‹¦æˆª**ï¼šå½“ç”¨æˆ·è¯·æ±‚ AI è§£è¯»æ—¶ï¼Œä¸­é—´ä»¶ä¼šæ‹¦æˆªè¯·æ±‚
2. **IP è¯†åˆ«**ï¼šè·å–è¯·æ±‚è€…çš„çœŸå® IP åœ°å€ï¼ˆæ”¯æŒä»£ç†ï¼‰
3. **è®¡æ•°æ£€æŸ¥**ï¼šæŸ¥è¯¢è¯¥ IP ä»Šå¤©çš„è¯·æ±‚æ¬¡æ•°
4. **é™åˆ¶åˆ¤æ–­**ï¼š
   - æœªè¾¾é™åˆ¶ï¼šå…è®¸è¯·æ±‚ï¼Œè®¡æ•° +1
   - å·²è¾¾é™åˆ¶ï¼šè¿”å› 429 é”™è¯¯
5. **å“åº”å¤´**ï¼šæ·»åŠ é™åˆ¶ä¿¡æ¯åˆ°å“åº”å¤´

## ğŸ“¡ API æ¥å£

### 1. è·å–å½“å‰ IP ä½¿ç”¨æƒ…å†µ

```http
GET /api/ai-interpretation/usage
```

å“åº”ç¤ºä¾‹ï¼š
```json
{
  "success": true,
  "data": {
    "date": "2024-01-20",
    "limit": 30,
    "used": 15,
    "remaining": 15,
    "resetAt": 1705795200000
  }
}
```

### 2. è·å–ä½¿ç”¨ç»Ÿè®¡æŠ¥å‘Šï¼ˆéœ€è¦ç™»å½•ï¼‰

```http
GET /api/ai-interpretation/usage/report?days=7
```

å“åº”ç¤ºä¾‹ï¼š
```json
{
  "success": true,
  "data": {
    "summary": [
      {
        "request_date": "2024-01-20",
        "unique_ips": 25,
        "unique_users": 18,
        "total_requests": 156
      }
    ],
    "todayTopUsers": [
      {
        "ip_address": "192.168.1.100",
        "user_id": 123,
        "request_count": 28,
        "endpoint": "/api/ai-interpretation/save"
      }
    ],
    "dailyLimit": 30,
    "rateLimitEnabled": true
  }
}
```

## ğŸ›¡ï¸ é”™è¯¯å¤„ç†

å½“è¾¾åˆ°é™åˆ¶æ—¶ï¼ŒAPI è¿”å› 429 çŠ¶æ€ç ï¼š

```json
{
  "error": "AI API è®¿é—®é™åˆ¶",
  "message": "æ‚¨ä»Šå¤©çš„ AI è§£è¯»æ¬¡æ•°å·²è¾¾ä¸Šé™ï¼ˆ30æ¬¡ï¼‰ã€‚è¯·æ˜å¤©å†è¯•ã€‚",
  "limit": 30,
  "used": 30,
  "resetAt": 1705795200000
}
```

## ğŸ“‹ å“åº”å¤´ä¿¡æ¯

æ¯ä¸ª AI è¯·æ±‚çš„å“åº”éƒ½åŒ…å«ä»¥ä¸‹å¤´ä¿¡æ¯ï¼š

- `X-AI-RateLimit-Limit`: æ¯æ—¥é™åˆ¶æ¬¡æ•°
- `X-AI-RateLimit-Remaining`: å‰©ä½™å¯ç”¨æ¬¡æ•°
- `X-AI-RateLimit-Reset`: é‡ç½®æ—¶é—´æˆ³

## ğŸ” ç›‘æ§å’Œç®¡ç†

### æŸ¥çœ‹ä»Šæ—¥ä½¿ç”¨æƒ…å†µ

```sql
SELECT ip_address, request_count 
FROM ai_api_usage 
WHERE request_date = date('now')
ORDER BY request_count DESC;
```

### æ¸…ç†å†å²æ•°æ®

```sql
DELETE FROM ai_api_usage 
WHERE request_date < date('now', '-30 days');
```

### ä¸´æ—¶è§£é™¤é™åˆ¶

å¦‚éœ€ä¸´æ—¶è§£é™¤æŸä¸ª IP çš„é™åˆ¶ï¼š

```sql
UPDATE ai_api_usage 
SET request_count = 0 
WHERE ip_address = 'ç›®æ ‡IP' 
  AND request_date = date('now');
```

## ğŸš€ éƒ¨ç½²æ³¨æ„äº‹é¡¹

1. **ä»£ç†é…ç½®**ï¼šå¦‚æœä½¿ç”¨åå‘ä»£ç†ï¼ˆå¦‚ Nginxï¼‰ï¼Œç¡®ä¿æ­£ç¡®è½¬å‘å®¢æˆ·ç«¯ IPï¼š
   ```nginx
   proxy_set_header X-Real-IP $remote_addr;
   proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
   ```

2. **æ—¶åŒºè®¾ç½®**ï¼šç¡®ä¿æœåŠ¡å™¨æ—¶åŒºæ­£ç¡®ï¼Œå½±å“æ¯æ—¥é‡ç½®æ—¶é—´

3. **æ•°æ®å¤‡ä»½**ï¼šå®šæœŸå¤‡ä»½ `ai_api_usage` è¡¨æ•°æ®ç”¨äºåˆ†æ

## ğŸ“ˆ æ‰©å±•å»ºè®®

1. **ç”¨æˆ·çº§é™åˆ¶**ï¼šå¯ä»¥ä¸ºæ³¨å†Œç”¨æˆ·æä¾›æ›´é«˜çš„é™é¢
2. **VIP åŠŸèƒ½**ï¼šä»˜è´¹ç”¨æˆ·å¯ä»¥è·å¾—æ›´å¤šé…é¢
3. **åŠ¨æ€è°ƒæ•´**ï¼šæ ¹æ®æœåŠ¡å™¨è´Ÿè½½åŠ¨æ€è°ƒæ•´é™åˆ¶
4. **é»‘åå•åŠŸèƒ½**ï¼šå¯¹æ¶æ„ IP è¿›è¡Œæ°¸ä¹…å°ç¦

## ğŸ”§ æ•…éšœæ’é™¤

### é™åˆ¶ä¸ç”Ÿæ•ˆ

1. æ£€æŸ¥ç¯å¢ƒå˜é‡ `AI_RATE_LIMIT_ENABLED` æ˜¯å¦ä¸º `true`
2. ç¡®è®¤æ•°æ®åº“è¡¨ `ai_api_usage` å·²åˆ›å»º
3. æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯

### IP åœ°å€è¯†åˆ«é”™è¯¯

1. æ£€æŸ¥åå‘ä»£ç†é…ç½®
2. æŸ¥çœ‹è¯·æ±‚å¤´ä¸­çš„ IP ä¿¡æ¯
3. è°ƒæ•´ `getClientIp` å‡½æ•°é€»è¾‘

---

é€šè¿‡åˆç†é…ç½® AI è®¿é—®é™åˆ¶ï¼Œå¯ä»¥æœ‰æ•ˆä¿æŠ¤ AI API èµ„æºï¼Œç¡®ä¿æœåŠ¡ç¨³å®šè¿è¡Œï¼Œä¸ºæ‰€æœ‰ç”¨æˆ·æä¾›å…¬å¹³çš„ä½¿ç”¨æœºä¼šã€‚